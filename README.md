# 9559 TP Backend

ITIL

## Requirements

- [uv](https://github.com/astral-sh/uv)
- `python`
- [docker](https://docs.docker.com/engine/install/) with `docker compose`
- Optional: `make` (to use Makefile to run docker commands)

## Technologies

- Database: PostgreSQL
- Backend: Python with [FastAPI](https://fastapi.tiangolo.com/)
- Migrations: Alembic

## Development

### Hot reloading

Run the following command to develop with hot-reloading (every change made to the code will automatically be reloaded in the container):

```sh
docker compose watch
```

or use

```sh
make watch
```

### Run containers

To run without hot-reloading use

```sh
make up
```

or to force build images and then run use

```sh
make run
```

### Migrations

In order to populate the database it is necessary to run migrations. The steps are the following:

1. Create the model under `app/models` with all its attributes.
2. Add the model to `app/alembic/env.py` like:

```py
from app.models.users import Usuario
```

3. Run

```sh
make enter_backend
```

to enter the backend container.

4. Once inside, run

```sh
alembic revision --autogenerate -m "{message}"
```

where `{message}` is the revision message, like "create user table" or "add column name to user table".
It will generate a file in `app/alembic/versions/` with the revision message and some random characters.

5. Check in the file created that the table is correctly setup. If you see something like this:

```py
def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    pass
    # ### end Alembic commands ###

def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    pass
    # ### end Alembic commands ###
```

then check step 2.

6. Inside the container you can run

```sh
alembic upgrade head
```

to apply the changes.

7. If you want to revert the changes you can use

```sh
alembic downgrade -1
```

or you can stop the containers, remove the volume and apply all migrations again (which shouldn't take too long):

```sh
make down # Stop the containers
make reset_db # Remove volume
make run # or `make up`, in any case it will run the migrations automatically
```

## API

The app will be running on `localhost:8000`.

To use Swagger UI (which provides an interface to interact with the API) use `localhost:8000/docs`.

## References

- [FastAPI template](https://github.com/fastapi/full-stack-fastapi-template)
- [Alembic](https://alembic.sqlalchemy.org/en/latest/)
- [SQLModel](https://sqlmodel.tiangolo.com/)
